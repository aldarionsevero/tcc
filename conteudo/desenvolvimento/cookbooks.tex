\section{\textit{Cookbook} Chef}
\label{sec:lev-rec}

Como descrito ne Seção~\ref{sec:chef}, o Chef é disposto em vários
componentes. O foco principal do Cupper é a criação de \textit{cookbooks},
sendo assim os recursos levantados são referentes à composição interna
dos \textit{cookbooks}.

Os \textit{cookbooks} contém os seguintes componentes: \textit{attributes, recipes, definitions,
files, libraries, custom resourses, metadata, resources e providers, templates
cookbook versions}~\cite{chefdoc:2016}.

Para o funcionamento de um \textit{cookbook}, com uma estrutura mínima, é necessário que tenha
ao menos um \textit{recipe default} definido. O exemplo~\ref{code:tree} mostra essa
estrutura mínima necessária para realizar a configuração do \textit{cookbook app} e o exemplo~\ref{code:fulltree} mostra uma estrutura completa.

\noindent\begin{minipage}{.45\textwidth}
  \lstinputlisting[language=Bash, frame=single, label=code:tree, caption="Estrutura mínima de um \textit{cookbook}"]{conteudo/code/minimal_tree}
\end{minipage}\hfill
\noindent\begin{minipage}{.45\textwidth}
  \lstinputlisting[language=Bash, frame=single, label=code:fulltree, caption="Estrutura completa de um \textit{cookbook}"]{conteudo/code/full_tree}
\end{minipage}

As subseções seguintes explicam os componentes dos \textit{cookbooks} e quais serão gerados
pelo Cupper.

\subsection{\textit{Attributes}}
\label{sec:lev-rec-att}

Os \textit{attributes} são os detalhes das especificações do \textit{node}. Definem~\cite{chefdoc:2016}:

\begin{itemize}
  \item o estado atual do \textit{node};
  \item em qual estado o \textit{node} estava após a última execução do \textit{chef-client};
  \item em qual estado o \textit{node} deve alcançar ao final na execução do \textit{chef-client} atual.
\end{itemize}

Os \textit{attributes} são definidos: no proprio ambiente através do Ohai, nos \textit{cookbooks},
nos \textit{roles} e \textit{environments}.

\textbf{Cupper}: será incluido no escopo de implementação. Os \textit{attributes} serão dispostos
de acordo com a coleta dos atributos do ambiente definidos na Seção~\ref{sec:cam-amb}.
Apenas alguns atributos serão inserido como informativo sobre o ambiente, ou seja,
não serão utilizados diretamente no \textit{recipe} do \textit{cookbook}.

\subsection{\textit{Recipes}}
\label{sec:lev-rec-rec}

Os \textit{recipes} são as unidade fundamentais para a execução de um \textit{cookbook}. Definem
todas as informações necessárias para configurar o sistema e segue algumas regras
~\cite{chefdoc:2016}:

\begin{itemize}
  \item Deve ser incluido em um \textit{cookbook};
  \item Deve ser posto em um \textit{run-list} antes de ser usado pelo \textit{chef-client};
  \item É executado na mesma ordem disposta na \textit{run-list};
  \item Pode ser incluído em outro \textit{recipe};
  \item Pode ter dependência de outros \textit{recipe};
  \item Pode marcar um \textit{node} para facilitar a criação de agrupamento.
\end{itemize}

As \textit{recipes} são escritas em Ruby e pode-se utilizar dos recursos providos
pela linguagem. Dispoem-se de uma coleção desse recursos que são utilizados
para definir as ações da \textit{recipes}. No exemplo \ref{code:recipe} utiliza-se
três recursos: \textit{package, service} e \textit{template}.

\begin{minipage}{.90\textwidth}
  \lstset{style=shell}
  \lstinputlisting[language=Bash, label=code:recipe, caption="Exemplo de \textit{recipe}. Define a instala{\c{c}}{\~a}o e configura{\c{c}}{\~a}o do \textit{app} Nginx"]{conteudo/code/recipe_example.rb}
\end{minipage}

\textbf{Cupper}: será incluido no escopo de implementação. Os \textit{recipes} é o componente chave a
ser gerado pelo Cupper. Nele serão descritos os passos, em sequência lógica de execução,
de todas as configurações. Para cada \textit{cookbook}, será gerado um arquivo de 
\textit{recipe 'default.rb'} contendo todas as informações necessárias para a execução.
A Seção~\ref{sec:cbresource} defini todos os recursos utilizados nos \textit{recipes}.

\subsection{\textit{Definitions}}
\label{sec:lev-rec-def}

As \textit{definitions} são um novo tipo de recurso disponível apartir da versão
12.5 do Chef e é recomentado utilizar o \textit{Custom Resource}(Seção \ref{sec:lev-rec-cust})
no lugar de \textit{definitions}~\cite{chefdoc:2016}.

Os \textit{definitions} são comportamento que podem ser reutilizados por outros \textit{recipes}.
São utilizado como recursos padrões de uma receita. No exemplo \ref{code:definition}
é definido o recurso \textit{host\_porter} com os parametros \textit{port} (valor padrão 4000)
e \textit{hostname} (valor padrão \textit{nil}) que pode ser utilizado em outro
\textit{recipe} com a simples chamada \textit{host\_porter}.

\begin{minipage}{.90\textwidth}
  \lstset{style=shell}
  \lstinputlisting[language=Bash, label=code:definition, caption="Exemplo de \textit{definition}. Adiciona um recurso \textit{host\_porter}."]{conteudo/code/definition_example.rb}
\end{minipage}

\textbf{Cupper}: não será incluso no escopo de implementação. As \textit{definitions} são
construídas de acordo com as necessidades de cada organização, não sendo
possível prevê-las ou fazer uma \textit{definition} genérica.

\subsection{\textit{Files}}
\label{sec:cbfiles}

Os \textit{Files} é um recurso referente a manipulação de arquivos no ambiente~\cite{chefdoc:2016}.
Pode-se utilizar os seguintes recursos:

\begin{itemize}
  \item \textit{cookbook\_file}: arquivos que são adicionados ao \textit{node} com base
    nos arquivos presentes no diretório \textit{/files} na raiz do \textit{cookbook};
  \item \textit{file}: manipula arquivos que estão presentes no \textit{node};
  \item \textit{remote\_file}: arquivos são adicionado ao \textit{node} a partir de um
    local remoto;
\end{itemize}

Cada recurso \textit{file} é utilizado para um propósito, mas os seus comportamentos
são similares. O exemplo \ref{code:file} mostra três maneira diferente de
inserir o arquivo \textit{eth1-conf} no ambiente.

\begin{minipage}{.90\textwidth}
  \lstset{style=shell}
  \lstinputlisting[language=Bash, label=code:file, caption="Exemplo de \textit{file}. Três modos de inserir o arquivo \textit{eth1-conf}."]{conteudo/code/file_example.rb}
\end{minipage}

\textbf{Cupper}: será incluido no escopo os recursos \textit{file} e \textit{cookbook\_file}.
A leitura de um arquivo de configuração ou de implantação de uma aplicação 
é replicado para a pasta \textit{cookbooks/COOKBOOK\_NAME/files/} de mesmo nome.
O \textit{cookbook\_file} será gerado apartir da coleta de arquivos considerado estáticos,
ou seja, o conteúdo não tem variação com relação a nenhum atributo do ambiente,
por exemplo o atributo IP do ambiente.

\subsection{\textit{Libraries}}

As \textit{libraries} são formas de inserir código Ruby para estender ou definir
uma nova funcionalidade. Semelhante ao que ocorre em \textit{definitions}, entretanto a
capacidade de extensão é maior, sendo possível estender recursos já
existentes~\cite{chefdoc:2016}. Por ser construída em Ruby, todos os
recursos provídos pela linguagem podem ser utilizadas dentro das
\textit{libraries}.

O exemplo \ref{code:library} mostra a definição para estender um
\textit{recipe} adicionando um método \textit{client} que pode ser utilizado
para facilitar a inserção de dados referente a \textit{ip} e \textit{hostname} de um
\textit{node}

\begin{minipage}{.90\textwidth}
  \lstset{style=shell}
  \lstinputlisting[language=Bash, label=code:library, caption="Exemplo de \textit{libraries}."]{conteudo/code/librarie_example.rb}
\end{minipage}

Em geral, as \textit{libraries} são usadas para definir novas funções que
auxiliam na descrição de rotinas que são mais frequentes durante a
construção de um \textit{recipe} como verificação de arquivos ou serviços.

\textbf{Cupper}: não será incluido no escopo, pois não é possível definir as \textit{libraries}
necessárias para um contexto desconhecido pelo Cupper.

\subsection{\textit{Custom Resource}}
\label{sec:lev-rec-cust}

Adicionado recentemente ao Chef, o \textit{custom resource} é uma forma de criar
novos recursos para os \textit{recipes}. É semelhante as \textit{libraries} e as \textit{definitions},
entretanto é direcionado especificamente para a criação de novos recursos~\cite{chefdoc:2016}.
É uma forma simples de estender o Chef e é implementado dentro de um
\textit{cookbook}.

No exemplo \ref{code:custom} tem-se a definição de um recurso criado em \textit{cookbooks/app/resources}
com o nome \textit{httpd} e uma propriedade \textit{homepage} com um valor padrão vazio.
Esse recurso é distribuido por todo o \textit{cookbooks} como uma simples chamada
de um recurso Chef como demonstra o código \ref{code:custom-user}.

\noindent\begin{minipage}{.45\textwidth}
  \lstset{style=shell}
  \lstinputlisting[language=Bash, label=code:custom, caption="Exemplo de declaração de um \textit{custom resource}."]{conteudo/code/custom_example.rb}
\end{minipage}\hfill
\begin{minipage}{.45\textwidth}
  \lstset{style=shell}
  \lstinputlisting[language=Bash, label=code:custom-user, caption="Exemplo de utilização de um \textit{custom resource}."]{conteudo/code/custom_user.rb}
\end{minipage}

\textbf{Cupper}: não será incluido no escopo, pois a definição dos \textit{custom resource} dependem
da necessidade de cada organização não sendo possível prevê-las.

\subsection{\textit{Metadata}}
\label{sec:cbmetadata}

\textit{Metadata} é um arquivo localizado na raiz do \textit{cookbook} como foi monstrado no código
\ref{code:fulltree}. Nele são definidos informações sobre o \textit{cookbook} como termos de \textit{copyright},
\textit{email} do criador ou da organização, licença, descrição, dependências, etc. São 
todas informações organizacionais e não são obrigatórias.

\textbf{Cupper}: será incluso no escopo de implementação. Será feito um arquivo padrão de
\textit{metadata} para a representação do \textit{cookbook} gerado pelo Cupper. O usuário deverá
modifica-lo de acordo com as suas necessidades.

\subsection{\textit{Resources e Providers}}
\label{sec:cbresource}

Um \textit{resource} é a definição do passo que deve ser seguido durante o processo
de configuração. Cada \textit{resource} diz ao \textit{chef-client} qual a tarefa a ser executada
como instalar um pacote, criar um arquivo, reiniciar um serviço, etc.
Enquanto o \textit{resource} diz o que deve ser feito, o \textit{provider} diz como deve ser
feito. Por exemplo, o \textit{resource} define \lq\lq instale o pacote A\rq\rq e o \textit{provider} decide
se deve utilizar pacotes deb ou rpm.

\textbf{Cupper}: será incluso no escopo de implementação. Os \textit{resources} padrões
providos pelo Chef serão utilizados para definir os passos nos arquivos de
\textit{recipes}. Os principais são:

\begin{itemize}
  \item \textit{\textbf{apt\_package}}: usado para gerenciar pacotes das plataformas Debian e
    Ubuntu;
  \item \textit{\textbf{cookbook\_file}}: transfere o arquivo definido em \textit{COOKBOOK\_NAME/files/} para
    uma localização definida (já descrito na Seção \ref{sec:cbfiles});
  \item \textit{\textbf{directory}}: usado para gerenciar diretórios. Pode-se criar, deletar, definir
    permissão, grupos, etc;
  \item \textit{\textbf{execute}}: usado para executar um comando. Por padrão, utiliza-se o \textit{bash};
  \item \textit{\textbf{file}}:usado para gerenciar arquivos (já descrito na Seção \ref{sec:cbfiles});
  \item \textit{\textbf{gem\_package}}: usado para gerenciar pacotes RubyGem;
  \item \textit{\textbf{link}}: usado para criar \textit{links} simbólicos ou real;
  \item \textit{\textbf{package}}: usado para gerenciar pacotes sem a necessidade de especificar a plataforma,
    ou seja, o \textit{provider} irá determinar qual gerenciador de pacote a plataforma utiliza;
  \item \textit{\textbf{pacman\_package}}: usado para gerenciar pacotes da plataforma Arch Linux;
  \item \textit{\textbf{service}}: usado para gerenciar serviços da plataforma;
  \item \textit{\textbf{user}}: usado para criar, atualizar, remover e bloquear/desbloquear um usuário da plataforma.
\end{itemize}

\subsection{\textit{Templates}}

Os \textit{templates} são arquivos no formato Embedded Ruby (ERB) e permitem gerar
dinamicamente textos de arquivos estáticos. São muito utilizados em arquivos
de configuração que devem ser modificados de acordo com o ambiente. Os
\textit{templates} são inseridos em \textit{COOKBOOK\_NAME/templates} e deve-se declarar o recurso
\textit{template} nos arquivos de \textit{recipes}.

\textbf{Cupper}: será incluso no escopo de implementação. A leitura de um arquivo de
configuração ou de implantação de uma aplicação será replicado para a
pasta \textit{cookbook/COOKBOOK\_NAME/templates/} de mesmo nome. Os \textit{templates} serão
gerados apartir da coleta de arquivos considerados din{\^a}mico, ou seja,
o conteúdo contem variáveis que estão relacionado ao atributo do ambiente,
por exemplo o IP do ambiente.

\subsection{\textit{Cookbook Version}}

As \textit{cookbook versions} são versionamentos dos \textit{cookbooks} usados para definir
diferentes versões baseados nas modificações realizadas. São definidas
  dentro do arquivo de \textit{metadata} descrito na Seção \ref{sec:cbmetadata}.

\textbf{Cupper}: será incluso no escopo de implementação. Será posto a versão inicial
do \textit{cookbook} e poderá ser modificado de acordo com as necessiades do usuários,
assim como definido para as outras informações do arquivo \textit{metadas.rb} (já definido
na Seção~\ref{sec:cbmetadata})

